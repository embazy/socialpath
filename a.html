<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Party Chat - BroadcastChannel</title>
<style>
  body { font-family: sans-serif; }
  #messages { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
  #messages li { margin: 5px 0; }
</style>
</head>
<body>
<h1>Party Chat</h1>

<div>
  <label>Your Name: <input type="text" id="username" placeholder="Enter name"></label>
</div>
<p>Connected users: <span id="userCount">0</span></p>

<input type="text" id="messageInput" placeholder="Type a message">
<button onclick="sendMessage()">Send</button>
<ul id="messages"></ul>

<script>
const STORAGE_KEY = 'party_chat_history';
const HEARTBEAT_KEY = 'chat_heartbeats';
const HEARTBEAT_INTERVAL = 1000; // 1 second
const channel = new BroadcastChannel('chat_channel');
const messagesEl = document.getElementById('messages');
const userCountEl = document.getElementById('userCount');

// Ask user for a name
let username = localStorage.getItem('chat_username') || '';
if (!username) {
    username = prompt("Enter your name") || "Anonymous";
    localStorage.setItem('chat_username', username);
}
document.getElementById('username').value = username;

// Update username if changed
document.getElementById('username').addEventListener('change', (e) => {
    username = e.target.value || 'Anonymous';
    localStorage.setItem('chat_username', username);
});

// Load old messages
let chatHistory = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
chatHistory.forEach(msg => addMessage(msg));

// BroadcastChannel message listener
channel.onmessage = (event) => {
    const msg = event.data;
    if (msg.type === 'chat') {
        addMessage(msg.text);
        chatHistory.push(msg.text);
        saveHistory();
    } else if (msg.type === 'heartbeat') {
        updateHeartbeats(msg.id, msg.timestamp);
    }
};

// Send chat message
function sendMessage() {
    const input = document.getElementById('messageInput');
    if (!input.value) return;

    const msg = `${username}: ${input.value}`;
    addMessage(msg);
    chatHistory.push(msg);
    saveHistory();

    // Broadcast chat message
    channel.postMessage({ type: 'chat', text: msg });
    input.value = '';
}

// Add message to UI
function addMessage(msg) {
    const li = document.createElement('li');
    li.textContent = msg;
    messagesEl.appendChild(li);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Save chat history
function saveHistory() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
}

// Heartbeat system for counting tabs
const tabId = Date.now() + Math.random();
let heartbeats = JSON.parse(localStorage.getItem(HEARTBEAT_KEY)) || {};

function sendHeartbeat() {
    const timestamp = Date.now();
    heartbeats[tabId] = timestamp;
    localStorage.setItem(HEARTBEAT_KEY, JSON.stringify(heartbeats));
    channel.postMessage({ type: 'heartbeat', id: tabId, timestamp });
    cleanHeartbeats();
    updateUserCount();
}

function updateHeartbeats(id, timestamp) {
    heartbeats[id] = timestamp;
    localStorage.setItem(HEARTBEAT_KEY, JSON.stringify(heartbeats));
    updateUserCount();
}

function cleanHeartbeats() {
    const now = Date.now();
    for (const id in heartbeats) {
        if (now - heartbeats[id] > HEARTBEAT_INTERVAL * 3) {
            delete heartbeats[id]; // remove inactive tabs
        }
    }
    localStorage.setItem(HEARTBEAT_KEY, JSON.stringify(heartbeats));
}

// Update connected user count in UI
function updateUserCount() {
    const count = Object.keys(heartbeats).length;
    userCountEl.textContent = count;
}

// Send heartbeat periodically
setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);
sendHeartbeat(); // initial
</script>
</body>
</html>
